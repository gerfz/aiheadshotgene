# ğŸ”’ Fix Clear Cache Exploit - Quick Start

## âš¡ TL;DR
Run the SQL script, deploy backend, test app. Done!

---

## ğŸš€ Step 1: Run SQL Migration

1. Go to **Supabase Dashboard** â†’ **SQL Editor**
2. Copy and paste the entire contents of:
   ```
   database/FINAL_DEVICE_TRACKING_FIX.sql
   ```
3. Click **Run**
4. You should see:
   ```
   âœ… Setup complete!
   total_profiles: X
   unique_devices: Y
   duplicate_accounts: Z
   ```

---

## ğŸ“¦ Step 2: Deploy Backend (if not already deployed)

The backend code is already updated! Just make sure it's deployed:

```bash
cd backend
npm install
npm run build
# Deploy to your hosting provider
```

**Note:** If your backend is already running, no changes needed! The code is already there.

---

## ğŸ“± Step 3: Test the App

### Clean Test (Recommended):
1. Go to **Supabase Dashboard** â†’ **Authentication** â†’ **Users**
2. Delete all test users
3. On your phone: **Settings** â†’ **Apps** â†’ **AI Headshot Generator** â†’ **Clear Data**
4. Open the app

### Test Scenario:
```
âœ… First open: 3 credits
âœ… Use 1 credit: 2 credits remaining
âœ… Clear app data
âœ… Open app again: 2 credits (not 3!) ğŸ‰
âœ… Use 1 credit: 1 credit remaining
âœ… Check database: All profiles with same device_id show 1 credit
```

---

## ğŸ” Verify It's Working

### Check Database:
1. Go to **Supabase Dashboard** â†’ **Table Editor** â†’ **profiles**
2. Look for profiles with the same `device_id`
3. They should all have the same `free_credits` value

### Check Logs:
Look for these messages in your app logs:
```
ğŸ“± Device ID: abc123
âœ… Anonymous user created: user-123
âœ… Credits refreshed: {"freeCredits": 2, ...}
```

---

## âœ… What Changed

### Database:
- âœ… Simple trigger that ONLY sets `device_id`
- âœ… No complex credit logic in triggers
- âœ… No database errors!

### Backend:
- âœ… Checks for existing `device_id` when creating profile
- âœ… Copies credits from oldest account
- âœ… Syncs credits across all accounts with same `device_id`

### Mobile:
- âœ… Simplified initialization
- âœ… Lets backend handle credit merging
- âœ… No complex logic needed!

---

## ğŸ› Troubleshooting

### Still getting 3 credits after clearing cache?

**Check 1:** Did you run the SQL migration?
```sql
-- Run this in Supabase SQL Editor to verify:
SELECT 
  device_id,
  COUNT(*) as accounts,
  MIN(free_credits) as credits
FROM profiles
WHERE device_id IS NOT NULL
GROUP BY device_id;
```

**Check 2:** Is the backend deployed?
- The backend needs to be running for credit merging to work
- Check your hosting provider (Render, Railway, etc.)

**Check 3:** Clear all test data and try again
- Delete all users in Supabase
- Clear app data on phone
- Start fresh

### Database error when creating user?

Run this to remove ALL triggers:
```sql
DROP TRIGGER IF EXISTS trigger_set_device_id_on_insert ON profiles;
DROP TRIGGER IF EXISTS trigger_sync_credits_on_update ON profiles;
DROP TRIGGER IF EXISTS trigger_set_device_id ON profiles;
DROP TRIGGER IF EXISTS trigger_set_device_id_simple ON profiles;
DROP TRIGGER IF EXISTS trigger_set_device_id_from_metadata ON profiles;
```

Then run the full migration again.

---

## ğŸ“Š Expected Results

### Database State After Testing:
| id | device_id | free_credits | created_at |
|----|-----------|--------------|------------|
| user-1 | abc123 | 1 | 2025-01-04 10:00 |
| user-2 | abc123 | 1 | 2025-01-04 10:05 |

Both accounts have:
- âœ… Same `device_id`
- âœ… Same `free_credits`
- âœ… Different `id` (UUID)

### App Behavior:
- âœ… First install: 3 credits
- âœ… After clearing cache: Same credits as before (not reset to 3!)
- âœ… Credits sync across all accounts from same device

---

## ğŸ‰ Success Criteria

You'll know it's working when:
1. âœ… SQL migration runs without errors
2. âœ… Clearing app data doesn't reset credits to 3
3. âœ… Database shows multiple profiles with same `device_id` and same `free_credits`
4. âœ… Using credits on one account updates all accounts with same `device_id`

---

## ğŸ“š More Info

For detailed explanation of how it works, see:
- `database/HOW_DEVICE_TRACKING_WORKS.md`

---

**Ready to test!** ğŸš€

